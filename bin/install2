#!/bin/bash


set -e


# Base installation ------------------------------------------------------------
install_apt_packages() {
    _info "Installing system requirements"

    local _FLAGS=(
        "--no-install-recommends"
        "--no-show-upgraded"
        "--quiet"
        "--yes"
    )

    local _PACKAGES=(
        "attr"
        "build-essential"
        "make-doc"
        "bzip2"
        "bzip2-doc"
        "curl"
        "devilspie2"
        "git"
        "git-flow"
        "tig"
        "htop"
        "less"
        "lsof"
        "pv"
        "python3"
        "python3-pip"
        "software-properties-common"
        "strace"
        "taskwarrior"
        "tmux"
        "tmux-plugin-manager"
        "tree"
        "universal-ctags"
        "unzip"
        "zip"
        "zsh"
        "zsh-autosuggestions"
        "zsh-doc"
        "zsh-syntax-highlighting"
    )

    local _COMMANDS=(
      "apt update"
      "&& apt upgrade ${_FLAGS[@]}"
      "&& apt install ${_FLAGS[@]} ${_PACKAGES[@]}"
    )

    if [ "$(id --user)" -eq 0 ]; then
      echo "${_COMMANDS[@]}" | bash --
    else
      echo "${_COMMANDS[@]}" | sudo --shell --
    fi
}


install_python_packages() {
    _info "Installing python requirements"

    local _FLAGS=(
        "--user"
        "--upgrade"
    )

    local _PACKAGES=(
        "pip"
        "cliff"
        "huggingface_hub[cli]"
        "kaggle"
        "powerline-gitstatus"
        "powerline-status"
    )

    pip3 install "${_FLAGS[@]}" "${_PACKAGES[@]}"
}


install_duplic8r() {
    _info "Installing duplic8r"

    local _DUPLIC8R_HOME="${HOME}/.duplic8r"
    local _SOURCE="${_DUPLIC8R_HOME}/homedir"
    local _TARGET="${HOME}/.config"
    local _REPO="https://github.com/axler8r/duplic8r.git"
    local _BRANCH="stable"
    if [ -n "${_DEVELOPMENT}" ]; then
        _BRANCH="development"
    fi

    if [ -d "${_DUPLIC8R_HOME}" ]; then
        cd "${_DUPLIC8R_HOME}"
        git pull origin "${_BRANCH}"
    else
        git clone --branch "${_BRANCH}" "${_REPO}" "${_DUPLIC8R_HOME}"
    fi

    if [ ! -d "${_TARGET}" ]; then
        mkdir --parents "${_TARGET}"
    fi
    
    local _FILES=(
        "XCompose"
        "ctags"
        "dircolors"
        "gitcommit"
        "gitconfig"
        "gitignore"
        "taskrc"
        "tigrc"
        "tmux.conf"
        "tmux_extend.zsh"
        "zshalias"
        "zshenv"
        "zshfunction"
        "zshprompt"
        "zshrc"
    )

    for file in "${_FILES[@]}"; do
        copy_file "${_SOURCE}/${file}" "${HOME}/.${file}"
    done

    local _CONFIGS=(
        "bat"
        "devilspie2"
        "julia"
        "kitty"
        "nvim"
    )

    for config in "${CONFIGS[@]}"; do
        copy_file "${_SOURCE}/config/${config}" "${_TARGET}"
    done

    if [ ! -d "${_TARGET}/Code/User" ]; then
        mkdir --parents "${_TARGET}/Code/User"
    fi

    cp "${_FLAGS[@]}" \
       "${_SOURCE}/config/Code/User/settings.json" \
       "${_TARGET}/Code/User/settings.json"
}


configure_tmux_plugin_manager() {
    _info "Configuring tmux plugin manager"

    local TMUX_PLUGINS_HOME="${HOME}/.tmux/plugins"

    if [ ! -d "${HOME}/.tmux" ]; then
        mkdir --parents "${TMUX_PLUGINS_HOME}"
    fi

    if [ -d /usr/share/tmux-plugin-manager ]; then
        if [ ! -L "${TMUX_PLUGINS_HOME}/tpm" ]; then
            ln --symbolic /usr/share/tmux-plugin-manager "${TMUX_PLUGINS_HOME}/tpm"
        fi
    fi
}


install_vim_plug() {
    _info "Installing vim plug"

    local _FLAGS=(
        "--create-dirs"
        "--fail"
        "--location"
        "--output"
    )

    if [ ! -f "${HOME}/.local/share/nvim/site/autoload/plug.vim" ]; then
        curl "${_FLAGS[@]}" "${HOME}/.local/share/nvim/site/autoload/plug.vim" \
            https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    fi

    nvim --headless +'PlugInstall --sync' +qa
}


install_asdf() {
    _info "Installing asdf"

    local _ASDF_PLUGINS=(
        "bat"
        "choose"
        "dive"
        "duf"
        "exa"
        "fd"
        "fzf"
        "github-cli"
        "jq"
        "just"
        "neovim"
        "nodejs"
        "ripgrep"
        "shellcheck"
        "tokei"
        "yq"
    )

    local _ASDF_LATEST
    _ASDF_LATEST=$(
        git -c \
        "versionsort.suffix=-" \
        ls-remote \
        --exit-code \
        --refs \
        --sort="version:refname" \
        --tags https://github.com/asdf-vm/asdf "*.*.*" \
        | tail --lines=1 \
        | cut --delimiter="/" --fields=3
    )

    if [ ! -d "${HOME}/.asdf" ]; then
        git clone https://github.com/asdf-vm/asdf.git "${HOME}/.asdf" --branch "${_ASDF_LATEST}"
        source "${HOME}/.asdf/asdf.sh"

        for _plugin in "${_ASDF_PLUGINS[@]}"; do
            echo "Installing ${_plugin}"
            asdf plugin add "${_plugin}"
            asdf install "${_plugin}" latest
            asdf global "${_plugin}" "$(asdf latest "${_plugin}")"
        done
    fi
}


set_default_shell() {
    _info "Setting default shell"

    if [ ! "${SHELL}" == "$(which zsh)" ]; then
        if [ "$(id --user)" -eq 0 ]; then
            echo chsh --shell "$(which zsh)" "${USER}" | bash --
        else
            echo chsh --shell "$(which zsh)" "${USER}" | sudo --shell --
        fi
    fi
}


# Extended installation --------------------------------------------------------
create_sandbox() {
    mkdir --parents "${_SANDBOX}"
}


destroy_sandbox() {
    rm --recursive --force "${_SANDBOX}"
}


install_snaps() {
    _info "Installing snaps"

    local _SNAPS=(
        "brave"
        "chromium"
        "code --classic"
        "obsidian --classic"
        "slides"
    )
    # Optional extras
    # "blender --classic"
    # "gimp"
    # "inkscape"
    # "obs-studio"
    # "slack"
    # "vlc"

    if [ "$(id --user)" -eq 0 ]; then
        echo snap refresh | bash --
    else
        echo snap refresh | sudo --shell --
    fi

    for _snap in "${_SNAPS[@]}"; do
        if [ "$(id --user)" -eq 0 ]; then
            echo snap install "${_snap}" | bash --
        else
            echo snap install "${_snap}" | sudo --shell --
        fi
    done
}


install_ctrlR() {
    _info "Installing ctrl+r"

    if [ ! -d "${HOME}/.zsh-hsmw" ]; then
        git clone https://github.com/zdharma-continuum/history-search-multi-word.git \
                  "${HOME}/.zsh-hsmw"
    else
        cd "${HOME}/.zsh-hsmw"
        git pull
    fi
}


install_fonts() {
    _info "Installing fonts"

    if [ ! -d "${HOME}/.fonts" ]; then
        mkdir "${HOME}/.fonts"
    fi

    cd "${_SANDBOX}"

    wget --quiet https://github.com/microsoft/cascadia-code/releases/download/v2111.01/CascadiaCode-2111.01.zip
    unzip CascadiaCode-2111.01.zip
    rm --force "${HOME}/.fonts/CascadiaCode*.ttf"
    mv --update ttf/CascadiaCode*.ttf "${HOME}/.fonts"
    rm --force --recursive "${_SANDBOX:?}/*"

    wget --quiet https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.0/CascadiaCode.zip
    unzip CascadiaCode.zip
    rm --force "${HOME}/.fonts/CaskaydiaCoveNerdFont*.ttf"
    mv --update CaskaydiaCoveNerdFont-{Regular,Italic,Bold,BoldItalic}.ttf "${HOME}/.fonts"
    rm --force --recursive "${_SANDBOX:?}/*"

    fc-cache --force --verbose
}


install_numix_square_icons() {
    _info "Installing numix square icons"

    sudo add-apt-repository ppa:numix/ppa
    sudo apt update && sudo apt install numix-icon-theme-square
}


install_kitty() {
    _info "Installing kitty"

    curl --location https://sw.kovidgoyal.net/kitty/installer.sh | sh --

    ln --symbolic --force \
       "${HOME}/.local/kitty.app/bin/kitty" \
       "${HOME}/.local/kitty.app/bin/kitten" \
       "${HOME}/.local/bin/"
    cp "${HOME}/.local/kitty.app/share/applications/kitty.desktop" \
       "${HOME}/.local/share/applications/"
    cp "${HOME}/.local/kitty.app/share/applications/kitty-open.desktop" \
       "${HOME}/.local/share/applications/"

    sed --in-place \
        "s|Icon=kitty|Icon=/usr/share/icons/Numix-Square/48/apps/kitty.svg|g" \
        "${HOME}"/.local/share/applications/kitty*.desktop
    sed --in-place \
        "s|Exec=kitty|Exec=/home/${USER}/.local/kitty.app/bin/kitty|g" \
        "${HOME}"/.local/share/applications/kitty*.desktop
}


install_docker_engine() {
    _info "Installing docker engine"

    if [ ! -x "$(which docker)" ]; then
        curl --location https://get.docker.com | bash --
        if [ "$(id --user)" -ne 0 ]; then
            echo usermod --append --groups docker "${USER}" | sudo --shell --
        fi
    fi
}


install_parallel() {
    _info "Installing parallel"

    if [ ! -x "$(which parallel)" ]; then
        cd "${_SANDBOX}"

        wget --quiet https://ftpmirror.gnu.org/parallel/parallel-latest.tar.bz2
        tar --extract --bzip2 --file parallel-latest.tar.bz2
        rm parallel-latest.tar.bz2
        cd parallel*
        ./configure --prefix="${HOME}/.local"
        make
        make install

        cd "${HOME}"
        rm -rf "${_SANDBOX:?}/*"
    fi
}


install_z() {
    _info "Installing z"

    local BIN_DIR="${HOME}/.local/bin"

    if [ ! -x "${BIN_DIR}/z.sh" ]; then
        cd "${_SANDBOX}"

        wget --quiet https://raw.githubusercontent.com/rupa/z/master/z.sh
        mv z.sh "${BIN_DIR}/z.sh"
        chmod +x "${BIN_DIR}/z.sh"

        cd "${HOME}"
        rm -rf "${_SANDBOX:?}/*"
    fi
}


# Helper functions -------------------------------------------------------------
_info() {
    local _MESSAGE=${1}

    echo
    echo "${_MESSAGE}"
    echo "------------------------------------------------------------"
}

_copy_file() {
    local _SOURCE=$1
    local _TARGET=$2
    local _FLAGS=(
        "--archive"
        "--checksum"
        "--itemize-changes"
    )

    rsync "${_FLAGS[@]}" "${_SOURCE}" "${_TARGET}"
}


# Main -------------------------------------------------------------------------
while [ $# -gt 0 ]; do
    case "${1}" in
        --development)
            _DEVELOPMENT=true
            ;;
        --in-container)
            _IN_CONTAINER=true
            ;;
        --snaps)
            _SNAPS=true
            ;;
        --fonts)
            _FONTS=true
            ;;
        --icons)
            _ICONS=true
            ;;
        --kitty)
            _KITTY=true
            ;;
        --docker)
            _DOCKER=true
            ;;
        --skip-extras)
            _SNAPS=true
            _FONTS=true
            _ICONS=true
            _KITTY=true
            _DOCKER=true
            ;;
        *)
            echo "Unknown option: ${1}"
            ;;
    esac
    shift
done
_SANDBOX=${HOME}/Downloads/Sandbox


install_all() {
    install_apt_packages
    install_python_packages
    install_duplic8r
    configure_tmux_plugin_manager
    install_vim_plug
    install_asdf
    set_default_shell

    create_sandbox
    if [ -n "${_IN_CONTAINER}" ]; then
        [ -n "${_SNAPS}"  ] && install_snaps
        [ -n "${_FONTS}"  ] && install_fonts
        [ -n "${_ICONS}"  ] && install_numix_square_icons
        [ -n "${_KITTY}"  ] && install_kitty
        [ -n "${_DOCKER}" ] && install_docker_engine
    else
        install_snaps
        install_fonts
        install_numix_square_icons
        install_kitty
    fi

    [ -z "${_SKIP_CTRLR}"    ] && install_ctrlR
    [ -z "${_SKIP_PARALLEL}" ] && install_parallel
    [ -z "${_SKIP_Z}"        ] && install_z
    destroy_sandbox
}


install_all


unset _SANDBOX
unset _DEVELOPMENT
unset _IN_CONTAINER
unset _SNAPS
unset _FONTS
unset _ICONS
unset _KITTY
unset _DOCKER
